"use strict";function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(a,i){try{var o=t[a](i),s=o.value}catch(e){return void r(e)}if(!o.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}return n("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function objectifyForm(e){for(var t={},r=0;r<e.length;r++)t[e[r].name]=e[r].value;return t}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),PRODUCT="5637ca44df92ea03009633b3",BuyScreen=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"getData",value:function(e,t){var r=this.getVariant(e,t),n={first_name:e.firstName,last_name:e.lastName,company:null,line1:e.address1,line2:e.address2,city:e.city,state:"US"===e.country?e.usState:e.state,zip:e.zip,country:e.country.toLowerCase(),phone:e.phone};return{user_id:"5637c8d966e9ec03008989ef",buyer:{email:e.email,first_name:e.firstName,last_name:e.lastName,phone:e.phone,notes:e.notes},shipping_address:n,billing_address:Object.assign({},n,{zip:e.billingZip}),line_items:[{product_id:PRODUCT,variant_id:r,quantity:parseInt(e.quantity)}],payment_source:{card:{name:e.firstName+" "+e.lastName,number:e.ccNumber,exp_month:e.expDate.split("/")[0],exp_year:e.expDate.split("/")[1],cvc:e.cvc}},discount_codes:[]}}},{key:"getVariant",value:function(e,t){var r=[];for(var n in e)n.startsWith("option_")&&r.push(e[n]);r=r.sort();var a=!0,i=!1,o=void 0;try{for(var s,c=t[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var u=s.value;if(u.options.ids.sort().join()===r.join())return u.id}}catch(e){i=!0,o=e}finally{try{!a&&c.return&&c.return()}finally{if(i)throw o}}}},{key:"calculateShipping",value:function(){function e(e,r){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=objectifyForm(t.serializeArray()),a=this.getData(n,r),t.find(".loading").show(),e.next=5,$.ajax({async:!0,crossDomain:!0,url:"https://wt-f938a32f745f3589d64a35c208dd4c79-0.run.webtask.io/celry-access/calculate-shipping",method:"POST",headers:{"content-type":"application/json"},processData:!1,data:JSON.stringify(a)});case 5:i=e.sent,t.find("#shipping").val("$"+(i.shipping/100).toFixed(2)),t.find("#subtotal").val("$"+(i.subtotal/100).toFixed(2)),t.find("#tax").val("$"+(i.taxes/100).toFixed(2)),t.find("#total").val("$"+(i.total/100).toFixed(2)),t.find(".loading").hide();case 11:case"end":return e.stop()}},e,this)}));return e}()},{key:"setupForm",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,$.ajax({url:"https://wt-f938a32f745f3589d64a35c208dd4c79-0.run.webtask.io/celry-access/products/"+PRODUCT});case 2:return r=e.sent,$("#description").html(r.data.description),n=r.data.options.map(function(e){return'<div class="form-group"><label for="'+e.id+'" class="col-2 col-form-label">'+e.name+':</label><select class="form-control form-control-danger col-6" id="option_'+e.id+'" name="option_'+e.id+'" required><option selected value="" disabled>Select '+e.name+"</option>"+e.values.map(function(e){return'<option value="'+e.id+'">'+e.name+"</option>"}).join("")+"</select></div>"}).join(""),t.find("#options").append(n),t.find('#country option[value="US"]').attr("selected","true"),t.find("#country").change(function(e){"US"===e.currentTarget.options[e.target.selectedIndex].value?(t.find("#usState").removeClass("hidden").attr('required', true),t.find("#state").addClass("hidden").attr('required', false)):(t.find("#state").removeClass("hidden").attr('required', true),t.find("#usState").addClass("hidden").attr('required', false)),t.validator('update'),i.calculateShipping(t,r.data.variants)}),t.find("#options select").change(function(e){i.calculateShipping(t,r.data.variants)}),t.find("#quantity").change(function(e){i.calculateShipping(t,r.data.variants)}),t.find("#ccNumber").keypress(function(e){String.fromCharCode(e.which).match(/[0-9- ]/)||e.preventDefault()}),t.find("#expDate").keypress(function(e){String.fromCharCode(e.which).match(/[0-9/]/)||e.preventDefault()}),t.on("validated.bs.validator",function(e){if("expDate"===e.relatedTarget.id){if(!e.relatedTarget.checkValidity())return $(e.relatedTarget).parent().addClass("has-danger"),!1;$(e.relatedTarget).parent().removeClass("has-danger")}}).on("invalid.bs.validator",function(e){console.log(e.relatedTarget.id+" "+e.detail)}),a=r.data.variants,e.abrupt("return",a);case 14:case"end":return e.stop()}},e,this)}));return e}()},{key:"submit",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i,o,s,c,u,order;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.orderForm,r=this.variants,t.find('button[type="submit"]').attr("disabled",!0),t.find(".submitting").show(),n=objectifyForm(t.serializeArray()),a=this.getData(n,r),e.prev=5,e.next=8,$.ajax({async:!0,crossDomain:!0,url:"https://api.trycelery.com/v2/orders/checkout",method:"POST",headers:{"content-type":"application/json"},processData:!1,data:JSON.stringify(a)});case 8:i=e.sent,order=i.data,o=order.total/100,s=order.currency,c=order.line_items.map(function(e){return e.celery_sku}).join(","),u="?number="+order.number+"&amount="+o+"&currency="+s+"&line_items="+c,window.location.replace(window.location.href+"../confirmation/"+u),e.next=23;break;case 17:e.prev=17,e.t0=e.catch(5),this.orderForm.find(".alert .title").text(e.t0.statusText),this.orderForm.find(".alert .description").text(e.t0.responseJSON.data),this.orderForm.find(".alert").show(),this.orderForm.find(".submitting").hide();case 23:case"end":return e.stop()}},e,this,[[5,17]])}));return e}()},{key:"runSetupForm",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setupForm(this.orderForm);case 2:this.variants=e.sent;this.orderForm.validator('update');case 3:case"end":return e.stop()}},e,this)}));return e}()},{key:"init",value:function(){var e=this;this.orderForm=$("form#orderForm");var t=this;this.orderForm.validator().find("button.submit").click(function(r){r.preventDefault(),void 0!==t.variants&&(e.orderForm.validator("validate"),t.orderForm[0].checkValidity()&&e.submit())}),$("#orderFormContainer").removeClass("invisible"),$("#loader-wrapper").addClass("loaded"),this.runSetupForm()}}]),e}();!function(){(new BuyScreen).init()}();